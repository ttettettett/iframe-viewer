<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パチンコデータピボットテーブル（差枚数フォルダ対応）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #fileSelector, #hallSelector, #filterSection {
            display: block;
            margin: 10px auto 20px auto;
        }

        #output {
            margin-top: 20px;
        }

        .filter-label {
            margin-right: 10px;
        }

        #daySelector {
            width: 100%;
            height: 150px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
</head>
<body>
    <div class="container">
        <h2>パチンコデータピボットテーブル（差枚数フォルダ対応）</h2>
        <select id="fileSelector">
            <option value="" disabled selected>ファイルを選択してください</option>
        </select>
        <select id="hallSelector">
            <option value="" disabled selected>ホールを選択してください</option>
        </select>

        <div id="filterSection">
            <label class="filter-label">開始日: <input type="date" id="startDate"></label>
            <label class="filter-label">終了日: <input type="date" id="endDate"></label>
            <div>
                <select id="daySelector" multiple>
                    <option value="01">1日</option>
                    <option value="02">2日</option>
                    <option value="03">3日</option>
                    <option value="04">4日</option>
                    <option value="05">5日</option>
                    <option value="06">6日</option>
                    <option value="07">7日</option>
                    <option value="08">8日</option>
                    <option value="09">9日</option>
                    <option value="10">10日</option>
                    <option value="11">11日</option>
                    <option value="12">12日</option>
                    <option value="13">13日</option>
                    <option value="14">14日</option>
                    <option value="15">15日</option>
                    <option value="16">16日</option>
                    <option value="17">17日</option>
                    <option value="18">18日</option>
                    <option value="19">19日</option>
                    <option value="20">20日</option>
                    <option value="21">21日</option>
                    <option value="22">22日</option>
                    <option value="23">23日</option>
                    <option value="24">24日</option>
                    <option value="25">25日</option>
                    <option value="26">26日</option>
                    <option value="27">27日</option>
                    <option value="28">28日</option>
                    <option value="29">29日</option>
                    <option value="30">30日</option>
                    <option value="31">31日</option>
                </select>
            </div>
            <button onclick="applyFilter()">適用</button>
        </div>

        <div id="output"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
    <script>
        const fileSelector = document.getElementById('fileSelector');
        const hallSelector = document.getElementById('hallSelector');
        const daySelector = document.getElementById('daySelector');
        let allData = [];
        let filteredData = [];

        // === 差枚数フォルダのファイル一覧を取得 ===
        fetch('/差枚数/')
            .then(response => response.json())
            .then(files => {
                files.forEach(file => {
                    if (file.endsWith(".csv")) {
                        fileSelector.innerHTML += `<option value="${file}">${file}</option>`;
                    }
                });
            })
            .catch(error => console.error("[ERROR] ファイル一覧の取得に失敗しました:", error));

        // === ファイル選択後の処理 ===
        fileSelector.addEventListener('change', (event) => {
            const fileName = event.target.value;
            fetch(`/差枚数/${fileName}`)
                .then(response => response.text())
                .then(csvData => {
                    Papa.parse(csvData, {
                        header: true,
                        complete: function(results) {
                            allData = results.data;

                            // === ホール名の抽出とセレクトボックス更新 ===
                            const halls = [...new Set(allData.map(row => row["ホール名"]))];
                            hallSelector.innerHTML = `<option value="" disabled selected>ホールを選択してください</option>`;
                            halls.forEach(hall => {
                                hallSelector.innerHTML += `<option value="${hall}">${hall}</option>`;
                            });
                        }
                    });
                })
                .catch(error => console.error("[ERROR] ファイルの読み込みに失敗しました:", error));
        });
    </script>
</body>
</html>